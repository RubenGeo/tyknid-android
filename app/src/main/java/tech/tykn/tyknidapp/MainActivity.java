package tech.tykn.tyknidapp;

import android.os.Bundle;
import android.system.ErrnoException;
import android.system.Os;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.widget.Button;
import android.widget.TextView;

import androidx.appcompat.app.AppCompatActivity;

import org.hyperledger.indy.sdk.IndyException;
import org.hyperledger.indy.sdk.anoncreds.AnoncredsResults;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.util.concurrent.ExecutionException;

import tech.tykn.tyknid.DID;
import tech.tykn.tyknid.Service;
import tech.tykn.tyknid.WalletAlreadyExistException;
import tech.tykn.tyknid.WalletCreationException;

public class MainActivity extends AppCompatActivity {


    private File createConfigFile(String testPoolIp) throws IOException {
        File configFile = File.createTempFile("pool_config", ".txn", this.getBaseContext().getCacheDir());
        String path = configFile.getAbsolutePath();
        String[] defaultTxns = new String[]{
                String.format("{\"reqSignature\":{},\"txn\":{\"data\":{\"data\":{\"alias\":\"Node1\",\"blskey\":\"4N8aUNHSgjQVgkpm8nhNEfDf6txHznoYREg9kirmJrkivgL4oSEimFF6nsQ6M41QvhM2Z33nves5vfSn9n1UwNFJBYtWVnHYMATn76vLuL3zU88KyeAYcHfsih3He6UHcXDxcaecHVz6jhCYz1P2UZn2bDVruL5wXpehgBfBaLKm3Ba\",\"blskey_pop\":\"RahHYiCvoNCtPTrVtP7nMC5eTYrsUA8WjXbdhNc8debh1agE9bGiJxWBXYNFbnJXoXhWFMvyqhqhRoq737YQemH5ik9oL7R4NTTCz2LEZhkgLJzB3QRQqJyBNyv7acbdHrAT8nQ9UkLbaVL9NBpnWXBTw4LEMePaSHEw66RzPNdAX1\",\"client_ip\":\"%s\",\"client_port\":9702,\"node_ip\":\"%s\",\"node_port\":9701,\"services\":[\"VALIDATOR\"]},\"dest\":\"Gw6pDLhcBcoQesN72qfotTgFa7cbuqZpkX3Xo6pLhPhv\"},\"metadata\":{\"from\":\"Th7MpTaRZVRYnPiabds81Y\"},\"type\":\"0\"},\"txnMetadata\":{\"seqNo\":1,\"txnId\":\"fea82e10e894419fe2bea7d96296a6d46f50f93f9eeda954ec461b2ed2950b62\"},\"ver\":\"1\"}", testPoolIp, testPoolIp),
                String.format("{\"reqSignature\":{},\"txn\":{\"data\":{\"data\":{\"alias\":\"Node2\",\"blskey\":\"37rAPpXVoxzKhz7d9gkUe52XuXryuLXoM6P6LbWDB7LSbG62Lsb33sfG7zqS8TK1MXwuCHj1FKNzVpsnafmqLG1vXN88rt38mNFs9TENzm4QHdBzsvCuoBnPH7rpYYDo9DZNJePaDvRvqJKByCabubJz3XXKbEeshzpz4Ma5QYpJqjk\",\"blskey_pop\":\"Qr658mWZ2YC8JXGXwMDQTzuZCWF7NK9EwxphGmcBvCh6ybUuLxbG65nsX4JvD4SPNtkJ2w9ug1yLTj6fgmuDg41TgECXjLCij3RMsV8CwewBVgVN67wsA45DFWvqvLtu4rjNnE9JbdFTc1Z4WCPA3Xan44K1HoHAq9EVeaRYs8zoF5\",\"client_ip\":\"%s\",\"client_port\":9704,\"node_ip\":\"%s\",\"node_port\":9703,\"services\":[\"VALIDATOR\"]},\"dest\":\"8ECVSk179mjsjKRLWiQtssMLgp6EPhWXtaYyStWPSGAb\"},\"metadata\":{\"from\":\"EbP4aYNeTHL6q385GuVpRV\"},\"type\":\"0\"},\"txnMetadata\":{\"seqNo\":2,\"txnId\":\"1ac8aece2a18ced660fef8694b61aac3af08ba875ce3026a160acbc3a3af35fc\"},\"ver\":\"1\"}", testPoolIp, testPoolIp),
                String.format("{\"reqSignature\":{},\"txn\":{\"data\":{\"data\":{\"alias\":\"Node3\",\"blskey\":\"3WFpdbg7C5cnLYZwFZevJqhubkFALBfCBBok15GdrKMUhUjGsk3jV6QKj6MZgEubF7oqCafxNdkm7eswgA4sdKTRc82tLGzZBd6vNqU8dupzup6uYUf32KTHTPQbuUM8Yk4QFXjEf2Usu2TJcNkdgpyeUSX42u5LqdDDpNSWUK5deC5\",\"blskey_pop\":\"QwDeb2CkNSx6r8QC8vGQK3GRv7Yndn84TGNijX8YXHPiagXajyfTjoR87rXUu4G4QLk2cF8NNyqWiYMus1623dELWwx57rLCFqGh7N4ZRbGDRP4fnVcaKg1BcUxQ866Ven4gw8y4N56S5HzxXNBZtLYmhGHvDtk6PFkFwCvxYrNYjh\",\"client_ip\":\"%s\",\"client_port\":9706,\"node_ip\":\"%s\",\"node_port\":9705,\"services\":[\"VALIDATOR\"]},\"dest\":\"DKVxG2fXXTU8yT5N7hGEbXB3dfdAnYv1JczDUHpmDxya\"},\"metadata\":{\"from\":\"4cU41vWW82ArfxJxHkzXPG\"},\"type\":\"0\"},\"txnMetadata\":{\"seqNo\":3,\"txnId\":\"7e9f355dffa78ed24668f0e0e369fd8c224076571c51e2ea8be5f26479edebe4\"},\"ver\":\"1\"}", testPoolIp, testPoolIp),
                String.format("{\"reqSignature\":{},\"txn\":{\"data\":{\"data\":{\"alias\":\"Node4\",\"blskey\":\"2zN3bHM1m4rLz54MJHYSwvqzPchYp8jkHswveCLAEJVcX6Mm1wHQD1SkPYMzUDTZvWvhuE6VNAkK3KxVeEmsanSmvjVkReDeBEMxeDaayjcZjFGPydyey1qxBHmTvAnBKoPydvuTAqx5f7YNNRAdeLmUi99gERUU7TD8KfAa6MpQ9bw\",\"blskey_pop\":\"RPLagxaR5xdimFzwmzYnz4ZhWtYQEj8iR5ZU53T2gitPCyCHQneUn2Huc4oeLd2B2HzkGnjAff4hWTJT6C7qHYB1Mv2wU5iHHGFWkhnTX9WsEAbunJCV2qcaXScKj4tTfvdDKfLiVuU2av6hbsMztirRze7LvYBkRHV3tGwyCptsrP\",\"client_ip\":\"%s\",\"client_port\":9708,\"node_ip\":\"%s\",\"node_port\":9707,\"services\":[\"VALIDATOR\"]},\"dest\":\"4PS3EDQ3dW1tci1Bp6543CfuuebjFrg36kLAUcskGfaA\"},\"metadata\":{\"from\":\"TWwCRQRZ2ZHMJFn9TzLp7W\"},\"type\":\"0\"},\"txnMetadata\":{\"seqNo\":4,\"txnId\":\"aa5e817d7cc626170eca175822029339a444eb0ee8f0bd20d3b0b76e566fb008\"},\"ver\":\"1\"}", testPoolIp, testPoolIp)
        };
        File file = new File(path);

        FileWriter fw = new FileWriter(file);
        for (String defaultTxn : defaultTxns) {
            fw.write(defaultTxn);
            fw.write("\n");
        }

        fw.close();

        return file;
    }
    File configFile = null;
    String padid;
    @Override
    protected void onCreate(Bundle savedInstanceState) {

        try {
            configFile = createConfigFile("10.0.0.2");
        } catch (IOException e) {
            e.printStackTrace();
        }
        final Service tyknService = new Service();
        super.onCreate(savedInstanceState);
        try {
            Os.setenv("EXTERNAL_STORAGE", getExternalFilesDir(null).getAbsolutePath(), true);
            Os.setenv("RUST_LOG","TRACE",true);
        } catch (ErrnoException e) {

            e.printStackTrace();
        }
        setContentView(R.layout.activity_main);

        final TextView statusBox = findViewById(R.id.statusBox);
        Button btnCreateWallet = findViewById(R.id.btnCreateWallet);
        btnCreateWallet.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                try {
                    tyknService.createWallet("testWallet","test");
                    statusBox.setText(String.format("Create wallet"));
                } catch (WalletCreationException | WalletAlreadyExistException | ExecutionException | InterruptedException | IndyException e) {
                    e.printStackTrace();
                }
            }
        });

        Button btnDeleteWallet = findViewById(R.id.btnDeleteWallet);
        btnDeleteWallet.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                try {
                    tyknService.deleteWallet("testWallet","test");
                    statusBox.setText(String.format("Delete wallet"));
                } catch ( IndyException | InterruptedException | ExecutionException e) {
                    e.printStackTrace();
                }
            }
        });

        Button btngenerateDID = findViewById(R.id.btngenerateDID);
        btngenerateDID.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                try {
                    DID did  = tyknService.generatePADID("testWallet","test");
                    padid = did.getDID();
                    statusBox.setText(String.format("DID: %s \nVerKey: %s",did.getDID(),did.getVerkey()));
                } catch ( IndyException | InterruptedException | ExecutionException e) {
                    e.printStackTrace();
                }
            }
        });
        String credential = "{\"schema_id\":\"Th7MpTaRZVRYnPiabds81Y:2:testScehma:3.0\",\"cred_def_id\":\"B3TVWsXcdEn3sXohFxT4QV:3:CL:12:test1\",\"rev_reg_id\":null,\"values\":{\"age\":{\"raw\":\"23\",\"encoded\":\"23\"},\"name\":{\"raw\":\"sami\",\"encoded\":\"7092402453723823421\"}},\"signature\":{\"p_credential\":{\"m_2\":\"64365669443195256820079175638704548971612612574362165752665041221900398836137\",\"a\":\"11910542297334249740689462244477526983903531581047505540573815084517557561474955528354145633086202107234558215581610351248498485830386692009142540362806297712911314123192867185216208157814540910909390851327837275896517749397326154743619098337050405869140108648584189803271032247252924483351400574307270014962916461202386479057268326872298366150614958340362208686653066441816582123465568678430126714355363301639963015939218168437475385570855664908556216398917847190442336299712006409056903261460756209801183033785467993118372178232448368924296671164766494478027367217273564153932945459497321008947068793682013732276363\",\"e\":\"259344723055062059907025491480697571938277889515152306249728583105665800713306759149981690559193987143012367913206299323899696942213235956742930302560925252378315141102996045127233\",\"v\":\"6208391503222540681588794424798122025441111499973446411550016401225028330541766766737080053775167212204249035355272661363133765429052319948413793109244645185358068026010822065098533721117732153666821176702174175371707320202800924121581640741930327952462983540323582272049354360310324323364119487453465898795633180535766943664287737274082276625111313404994319825161750107370075779952244364252018517348165810986707583644746080889896873253215938969967515232760165844866628057727921500027396396890184174203808765243107077512882700108672194037164038723922118314565903592801348622728151494711462671178224679798772555359610617637299700389423712010868913760630088114062623788999253145431067277787076308872410991671057664868701950695581531004609802626937043526967375175441052079773006716588122810490433479076578986118384350762988\"},\"r_credential\":null},\"signature_correctness_proof\":{\"se\":\"4581785162892461715635312609180626461128858407002217061816888472833538145583346049013661349666280098248306720043856815122094100057801497076795663722136999880778604205204559872693654652706669858349004402590807720354368839875178684414653394108855856356093063584817979421887396741772551513670580342327302455583240183426929441000783844969188429632916989569271179413635450219107332391087584365934855742533060901409410422426636527861083453266573607165283466678050179999576881722913798750620062374143614448752756280031100102691768766028498147489345233573668754709203473311988821278883197908163606261598803515484327503575151\",\"c\":\"97724117375856752905730937528223180361885254250263562763536035621285370610484\"},\"rev_reg\":null,\"witness\":null}";

        Button btnRqstCred = findViewById(R.id.btnRqstCred);
        btnRqstCred.setOnClickListener(new View.OnClickListener() {
            String credDefId = "B3TVWsXcdEn3sXohFxT4QV:3:CL:12:test1";
            String offerJson = "{\"schema_id\":\"Th7MpTaRZVRYnPiabds81Y:2:testScehma:3.0\",\"cred_def_id\":\"B3TVWsXcdEn3sXohFxT4QV:3:CL:12:test1\",\"key_correctness_proof\":{\"c\":\"25565201637629958091124968457914872285227981834825410114028676383184353281913\",\"xz_cap\":\"343193569616593118156878085219193004022935122376976977748159972638605969745201327057237161579455328062496443061085766795299638289648724305796438273841169152484367153665864768870548409639624877190678970505164707188203175819076684088676307825608645566029826134593726990133075066988354081042082853106727891596354862011142692809479760171162698643877407790242659466499901343047656193449172308669739091041805734398897543438328192614341907385496931480506646148453495161134992766582084543360181731444502663928949998723218291253541888208017712316091296019763694081736926431417569718954961530182656601650788331747754180537577459823963492781216999053797581736411502939525278943060575881257338556267751954\",\"xr_cap\":[[\"name\",\"339980607051428561434881651942650451448486392219325242450608826196979054852040217776706223944272071368321181523466674030170453874143893368879668632360835858871121138348364270380072868837802886761292430164055547367467577694571222959665862015692208341141143380803197559552232930559948203794132614223773155976582975705930026631539532993496226346394426082319726330414738268295011660540072541176301905856976887687419702157429714412444239407304519113596864666906417275402868940719775128529971428624581284453127282382154617000880108326856833820156277631863383082524621287648138764629573657312344325059614649019579265988551815098734541744686510175939003236291942775916516176753635654702644612635011484\"],[\"age\",\"226316315152588517581729276553504525921425976655105276796224879560895853083855358855291302670178704234354806080076587142178248672398088206471811156236753549769618146758748508192677451238985446762076294474954221512363640713128907454088221298045583974740851159704627455368601121359393445463577132342936563163372394179489348981604402911849174860786142762319612796086752506957878875743507106959436170107232936245899217529588950093806069312327327096405423096366184603851133534927300096992111027120502994840262825392586704340769469541963790760456232566559721392615775498132281569383715917789589745595950099545205205844056856027125404718970725665637397767675591494305624146554781604173825853601950972\"],[\"master_secret\",\"467514575830335099478090128339164288404342772308452247071254351440932247393625168610451255648596112423079162010201930562854565915954729237241564748038477834720107101982819402025138218718646908587056193201148807346905432415176949320150743705360153924605666004383960016428788205597470781227134310582138045080795280527572243210069385463351661929907245946384543700660416936781484273570100519319221312033651316812079910531636632457858165670281920246610841123019115458051267994523580318548107498792331765598596924197102590582317225124351013739956467613407582124638384766645374280114869471875376920096787777663887970091748257903448156440375482466902594962222865691483258408146944998068770250691600801\"]]},\"nonce\":\"148498066906060007868354\"}";
            @Override
            public void onClick(View view) {
                try {
                    AnoncredsResults.ProverCreateCredentialRequestResult res = tyknService.createCredentialRequest("testWallet","test",configFile,padid,credDefId,offerJson);
                    statusBox.setText(String.format("json: %s \n metadata: %s",res.getCredentialRequestJson(),res.getCredentialRequestMetadataJson()));
                } catch ( IndyException | InterruptedException | ExecutionException e) {
                    e.printStackTrace();
                }

            }
        });

        Button btnAcceptCred = findViewById(R.id.btnAcceptCred);
        btnAcceptCred.setOnClickListener(new View.OnClickListener() {
            String credDefId = "B3TVWsXcdEn3sXohFxT4QV:3:CL:12:test1";
            String offerJson = "{\"schema_id\":\"Th7MpTaRZVRYnPiabds81Y:2:testScehma:3.0\",\"cred_def_id\":\"B3TVWsXcdEn3sXohFxT4QV:3:CL:12:test1\",\"key_correctness_proof\":{\"c\":\"25565201637629958091124968457914872285227981834825410114028676383184353281913\",\"xz_cap\":\"343193569616593118156878085219193004022935122376976977748159972638605969745201327057237161579455328062496443061085766795299638289648724305796438273841169152484367153665864768870548409639624877190678970505164707188203175819076684088676307825608645566029826134593726990133075066988354081042082853106727891596354862011142692809479760171162698643877407790242659466499901343047656193449172308669739091041805734398897543438328192614341907385496931480506646148453495161134992766582084543360181731444502663928949998723218291253541888208017712316091296019763694081736926431417569718954961530182656601650788331747754180537577459823963492781216999053797581736411502939525278943060575881257338556267751954\",\"xr_cap\":[[\"name\",\"339980607051428561434881651942650451448486392219325242450608826196979054852040217776706223944272071368321181523466674030170453874143893368879668632360835858871121138348364270380072868837802886761292430164055547367467577694571222959665862015692208341141143380803197559552232930559948203794132614223773155976582975705930026631539532993496226346394426082319726330414738268295011660540072541176301905856976887687419702157429714412444239407304519113596864666906417275402868940719775128529971428624581284453127282382154617000880108326856833820156277631863383082524621287648138764629573657312344325059614649019579265988551815098734541744686510175939003236291942775916516176753635654702644612635011484\"],[\"age\",\"226316315152588517581729276553504525921425976655105276796224879560895853083855358855291302670178704234354806080076587142178248672398088206471811156236753549769618146758748508192677451238985446762076294474954221512363640713128907454088221298045583974740851159704627455368601121359393445463577132342936563163372394179489348981604402911849174860786142762319612796086752506957878875743507106959436170107232936245899217529588950093806069312327327096405423096366184603851133534927300096992111027120502994840262825392586704340769469541963790760456232566559721392615775498132281569383715917789589745595950099545205205844056856027125404718970725665637397767675591494305624146554781604173825853601950972\"],[\"master_secret\",\"467514575830335099478090128339164288404342772308452247071254351440932247393625168610451255648596112423079162010201930562854565915954729237241564748038477834720107101982819402025138218718646908587056193201148807346905432415176949320150743705360153924605666004383960016428788205597470781227134310582138045080795280527572243210069385463351661929907245946384543700660416936781484273570100519319221312033651316812079910531636632457858165670281920246610841123019115458051267994523580318548107498792331765598596924197102590582317225124351013739956467613407582124638384766645374280114869471875376920096787777663887970091748257903448156440375482466902594962222865691483258408146944998068770250691600801\"]]},\"nonce\":\"148498066906060007868354\"}";
            String credential = "{\"schema_id\":\"Th7MpTaRZVRYnPiabds81Y:2:testScehma:3.0\",\"cred_def_id\":\"B3TVWsXcdEn3sXohFxT4QV:3:CL:12:test1\",\"rev_reg_id\":null,\"values\":{\"age\":{\"raw\":\"23\",\"encoded\":\"23\"},\"name\":{\"raw\":\"sami\",\"encoded\":\"7092402453723823421\"}},\"signature\":{\"p_credential\":{\"m_2\":\"64365669443195256820079175638704548971612612574362165752665041221900398836137\",\"a\":\"11910542297334249740689462244477526983903531581047505540573815084517557561474955528354145633086202107234558215581610351248498485830386692009142540362806297712911314123192867185216208157814540910909390851327837275896517749397326154743619098337050405869140108648584189803271032247252924483351400574307270014962916461202386479057268326872298366150614958340362208686653066441816582123465568678430126714355363301639963015939218168437475385570855664908556216398917847190442336299712006409056903261460756209801183033785467993118372178232448368924296671164766494478027367217273564153932945459497321008947068793682013732276363\",\"e\":\"259344723055062059907025491480697571938277889515152306249728583105665800713306759149981690559193987143012367913206299323899696942213235956742930302560925252378315141102996045127233\",\"v\":\"6208391503222540681588794424798122025441111499973446411550016401225028330541766766737080053775167212204249035355272661363133765429052319948413793109244645185358068026010822065098533721117732153666821176702174175371707320202800924121581640741930327952462983540323582272049354360310324323364119487453465898795633180535766943664287737274082276625111313404994319825161750107370075779952244364252018517348165810986707583644746080889896873253215938969967515232760165844866628057727921500027396396890184174203808765243107077512882700108672194037164038723922118314565903592801348622728151494711462671178224679798772555359610617637299700389423712010868913760630088114062623788999253145431067277787076308872410991671057664868701950695581531004609802626937043526967375175441052079773006716588122810490433479076578986118384350762988\"},\"r_credential\":null},\"signature_correctness_proof\":{\"se\":\"4581785162892461715635312609180626461128858407002217061816888472833538145583346049013661349666280098248306720043856815122094100057801497076795663722136999880778604205204559872693654652706669858349004402590807720354368839875178684414653394108855856356093063584817979421887396741772551513670580342327302455583240183426929441000783844969188429632916989569271179413635450219107332391087584365934855742533060901409410422426636527861083453266573607165283466678050179999576881722913798750620062374143614448752756280031100102691768766028498147489345233573668754709203473311988821278883197908163606261598803515484327503575151\",\"c\":\"97724117375856752905730937528223180361885254250263562763536035621285370610484\"},\"rev_reg\":null,\"witness\":null}";
            @Override
            public void onClick(View view) {
                try {
                    tyknService.saveCredential("testWallet","test",configFile,padid,credDefId,offerJson,credential);
                    statusBox.setText("credential saved!");
                } catch ( IndyException | InterruptedException | ExecutionException e) {
                    e.printStackTrace();
                }
            }
        });

    }

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        // Inflate the menu; this adds items to the action bar if it is present.
        getMenuInflater().inflate(R.menu.menu_main, menu);
        return true;
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        // Handle action bar item clicks here. The action bar will
        // automatically handle clicks on the Home/Up button, so long
        // as you specify a parent activity in AndroidManifest.xml.
        int id = item.getItemId();

        //noinspection SimplifiableIfStatement
        if (id == R.id.action_settings) {
            return true;
        }

        return super.onOptionsItemSelected(item);
    }
}
